# AI Blox Orchestrator – Database Design (v0.1)

## Purpose

This document defines the **v0.1 database schema** for the AI Blox Orchestrator.
It is intentionally minimal and retrieval-oriented.

Ingestion and transformation pipelines are out of scope for this repository.

---

## Core Decisions

### 1) Database: PostgreSQL / Supabase PostgreSQL
- Target database is PostgreSQL.
- Supabase compatibility is required (Supabase is PostgreSQL).
- Features used: `tsvector` (FTS). `pgvector` may be enabled later.

### 2) Schema awareness: Pattern A (per-model schema)
- All ORM models must declare schema explicitly using:
  - `__table_args__ = {"schema": settings.db_schema}`
- Default schema for this repo: **`kb`**.
- The system must not assume `public`.

### 3) UUID everywhere
- All identifiers use UUID (no auto-increment integers).
- Tables use UUID primary keys even if additional uniqueness constraints exist.

### 4) Dependency injection for DB access
- DB engine/session creation is centralized in a small module for convenience.
- Access is provided via **dependency injection**, not global singletons.
- Repositories receive a `session_factory` (AsyncSession provider).

### 5) Flexible start on embeddings (Option B)
- v0.1 does **not** commit to a specific embedding model or dimension.
- Therefore:
  - `kb.kb_items` does **not** include an embedding column in v0.1.
  - `kb.kb_chunk_cache` does **not** include an embedding column in v0.1.
- Embedding columns can be added later once the first real embedding model is selected.

### 6) Late chunking first, cache is derived
- Canonical truth is stored at document/item level (`kb_items.content_text`).
- Chunks are derived and may be cached in `kb_chunk_cache`.
- Multiple chunkers are supported via `chunker_id`.

---

## Schema: `kb`

All tables in this repo live in schema `kb` (configurable via `settings.db_schema`).

---

## Table: `kb.kb_items` (canonical items)

Purpose:
- Store canonical “knowledge base items” to retrieve against.
- Provide coarse candidate recall using full-text search.

Columns (v0.1):
- `id UUID PRIMARY KEY`
- `owner_user_id UUID NOT NULL`
- `kind TEXT NOT NULL`
- `source TEXT NOT NULL`
- `source_ref TEXT NULL`
- `title TEXT NULL`
- `summary TEXT NULL`
- `content_text TEXT NOT NULL`
- `content_hash TEXT NULL`
- `metadata JSONB NOT NULL DEFAULT '{}'::jsonb`
- `tsv TSVECTOR NULL`
- `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`
- `updated_at TIMESTAMPTZ NOT NULL DEFAULT now()`

Indexes (v0.1):
- `GIN(tsv)`
- `BTREE(owner_user_id)`

Optional uniqueness constraints (choose later if needed):
- `UNIQUE(owner_user_id, source, source_ref)` when `source_ref` is stable and not null
- OR `UNIQUE(owner_user_id, source, content_hash)` when content_hash is reliably computed

Notes:
- `tsv` should be populated by application logic initially (v0.1).
  (Trigger-based maintenance can be added later.)

---

## Table: `kb.kb_chunk_cache` (derived late-chunk cache)

Purpose:
- Cache derived chunks for late chunking.
- Support second-pass evidence selection without committing to embedding dims.

Columns (v0.1 minimal):
- `id UUID PRIMARY KEY`
- `item_id UUID NOT NULL REFERENCES kb.kb_items(id) ON DELETE CASCADE`
- `owner_user_id UUID NOT NULL`
- `content_hash TEXT NOT NULL`
- `chunker_id TEXT NOT NULL`
- `embed_model_id TEXT NULL`
- `chunk_index INT NOT NULL`
- `chunk_text TEXT NOT NULL`
- `start_idx INT NULL`
- `end_idx INT NULL`
- `token_count INT NULL`
- `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`

Indexes/constraints (v0.1):
- `BTREE(item_id)`
- `BTREE(owner_user_id)`
- Uniqueness to avoid duplicate cache entries:
  - `UNIQUE(item_id, content_hash, chunker_id, embed_model_id, chunk_index)`
  (Implementation may normalize embed_model_id to a non-null sentinel if needed.)

Notes:
- No embedding column in v0.1 by design.
- This table stores derived data; cache misses are acceptable.

---

## Alembic / migrations

- Alembic is the migration tool.
- Migrations must:
  - create schema `kb` if it does not exist
  - create the two tables + indexes
  - support schema-aware autogeneration (include_schemas=True)

---

## Out of Scope

- Ingestion pipelines, staging schemas, transformation jobs
- OLAP schemas and analytics materializations
- Background jobs and persistence beyond session scope
- Multi-tenant org-level separation (beyond owner_user_id)
